#Platform & opt/dbg - independent flags and variables:

export FFLAGS="${FFLAGS} -Wno-globals"

FFLAGSSHARED=-fPIC
CFLAGSSHARED=-fPIC
CXXFLAGSSHARED=-fPIC

LDFLAGSSHARED="${CXXFLAGS} -pthread -fPIC"

if [ ${ARCH} = "Linux" ]; then
  export FC=g77
  export FLIBS=" -lfrtbegin -lg2c "
elif [ ${ARCH} = "Linux-gcc4" ]; then   # Linux platform with gcc4: new Fortran90 compiler.
  export FC=gfortran
  export FLIBS=" -lgfortran -lgfortranbegin "
fi

echo "Assuming the fortran compiler to be ... "$FC
echo -n "Checking whether fortran compiler is in your PATH ... "
WFC=`which ${FC}`
if [ "x$WFC" = "x" ] ; then
   echo "not found. Check your installation and PATH variable."
   exit
fi
if [ ! -x $WFC ] ;then
   echo " strange enough. $WTC is not executable?"
   exit
fi

echo $WFC
echo -n "Checking whether it creates objects with your FFLAGS ... "
cat > __chfor__.f << EOT
       program chfor
       implicit none 
       stop
       end
EOT

${FC} ${FFLAGS} -c -o __chfor__.o  __chfor__.f

if [ ! -s __chfor__.o ] ; then 
   echo "$FC $FFLAGS -c -o __chfor__.o __chfor__.f   failed."
   FAIL=1
else
   echo " yes"
   echo -n "Checking whether we can create a working  executable from object ... "
   ${CXX}  -o __chfor__ __chfor__.o ${FLIBS}
   if [ -x __chfor__ ] && ./__chfor__ ; then
      echo yes
   else
      echo "no. ${CXX} -o __chfor__ __chfor__.o ${FLIBS} failed."
      FAIL=1
   fi
fi

rm -f __chfor__*

if [ "x$FAIL" = "x1" ] ; then 
   exit
fi

echo -n "Checking if we can create a shared library .. "
cat > __chsub__.f <<EOT
       subroutine chsub
       implicit none
       return
       end
EOT

command="${FC} ${FFLAGS} ${FFLAGSSHARED} -c -o __chsub__.o __chsub__.f"
`${command}`
if [ ! -s __chsub__.o ]  ; then
   echo "${command} failed"
   FAIL=1
else
   echo -n " object created ... "
   command="${CXX} ${LDFLAGSSHARED}  -o lib__chsub__.so __chsub__.o  -shared -Wl,-soname,lib__chsub__.so"
   `${command}`
   if [ -x lib__chsub__.so ] ; then
      echo " yes"
   else
      echo " no. ${command} failed"
      FAIL=1
      rm -f *__chsub__*
   fi
fi

if [ "x$FAIL" = "x1" ] ; then
   exit
fi


echo -n "Checking if we can create an archive library ... " 
command="ar cru lib__chsub__.a __chsub__.o"
`${command}`
if [ -s lib__chsub__.a ] ; then 
   echo " yes"
else 
   echo " no. ${command} failed."
   FAIL=1
fi

rm -f *__chsub__*

if [ "x$FAIL" = "x1" ] ; then
   exit
fi

